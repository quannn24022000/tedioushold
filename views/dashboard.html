<html>

<head>
    <link rel="stylesheet" href="/style/dashboard.css"> 
    <title>Dashboard</title>
</head>

<body>
    <div id="header" >
        <h1 >CAMERA DASHBOARD</h1>
        <div class="mode-back">
            <div id="logout" onclick="handler_logout()">
                <p>Back</p>
            </div>
        </div>
    </div>  
    <div class="cards">
        <div class="card">
            <h2><b>CAM 1<span class="dot" id= "cam_1_red_dot" style="visibility: hidden"></span></b></h2>
            <div class="module">
                <img id="ESP32-1" style="visibility: hidden" src=""/>
                <h2 id="current-timer1" style="visibility: hidden"></h2>
            </div>
        </div>
        <div class="card">
            <h2><b>CAM 2<span class="dot" id= "cam_2_red_dot" style="visibility: hidden"></span></b></h2>
            <div class="module">
                <img id="ESP32-2" style="visibility: hidden" src="" />
                <h2 id="current-timer2" style="visibility: hidden"></h2>
            </div>
        </div>
    </div>
    <div class="button">
        <div class="card">
            <div class= 'container'>
                <div class="mode">
                    <button class="button-1" id="cam_1_enabler" onclick="handler_play_button1()">
                        <p>Play</p>
                    </button>
                    <button class="button-1" id="cam_1_save" onclick="handler_save_image('cam_1_enabler')">
                        <p>Save image</p>
                    </button>
                    <button class="button-1" id="cam_1_mode" onclick="handler_camera_1()">
                        <p id="text_camera1">Review</p>
                    </button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class= 'container'>
                <div class="mode">
                    <button class="button-2" id="cam_2_enabler" onclick="handler_play_button2()">
                        <p>Play</p>
                    </button>
                    <button class="button-2" id="cam_2_save" onclick="handler_save_image('cam_2_enabler')">
                        <p>Save image</p>
                    </button>
                    <button class="button-2" id="cam_2_mode" onclick="handler_camera_2()">
                        <p id="text_camera2">Review</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let urlObject_1, urlObject_2;
        var imageFrame;

        const WS_URL = 'ws:///42.117.129.71:8888';
        const ws = new WebSocket(WS_URL);
        const img_1 = document.getElementById("ESP32-1");
        const img_2 = document.getElementById("ESP32-2");

        //1. Khởi tạo ở giá trị "pause" và đợi chờ đến "play" để phát video
        window["cam_1_enabler"] = false;
        window["cam_2_enabler"] = false;

        //2.1 Handler message from Websocket for single camera
        // const img = document.querySelector('img');
        // const WS_URL = 'ws:///192.168.3.122:8888';
        // const ws = new WebSocket(WS_URL);
        // let urlObject;
        // ws.onopen = () => console.log(`Connected to ${WS_URL}`);
        // ws.onmessage = message => {
        //     const arrayBuffer = message.data;
        //     if(urlObject){
        //         URL.revokeObjectURL(urlObject);
        //     }
        //     urlObject = URL.createObjectURL(new Blob([arrayBuffer]));
        //     img_1.src = urlObject;
        // }

        //2.2 Function for MULTIPLE CAMERA
        ws.onopen = () => {
            console.log(`Connected to ${WS_URL}`);
            ws.send("WEB_CLIENT");
        };

        ws.onmessage = async (message) => {
            const arrayBuffer = message.data;
            var blobObj = new Blob([arrayBuffer]);          // construct of Blob has array argument (Blob là đối tượng chuyển đổi file ảnh, mảng thành dạng URL và nhờ vào URL để show ảnh )
            const buf = await blobObj.arrayBuffer();
            var uint8 = new Uint8Array(buf.slice(12, 13));  // get ID camera
            var currentCam = uint8[0];                      // beacause an array has one element

            if(currentCam == 1)
            {
                imageFrame = img_1;
                document.getElementById("cam_1_red_dot").style.visibility = "visible";
                if(!window["cam_1_enabler"]) return;
                if (urlObject_1) {
                    URL.revokeObjectURL(urlObject_1);
                }
                urlObject_1 = URL.createObjectURL(blobObj);
                imageFrame.src = urlObject_1;
            }
            if(currentCam == 2)
            {
                imageFrame = img_2;
                document.getElementById("cam_2_red_dot").style.visibility = "visible";
                if (!window["cam_2_enabler"]) return;
                if (urlObject_2) {
                    URL.revokeObjectURL(urlObject_2);
                }
                urlObject_2 = URL.createObjectURL(blobObj);
                imageFrame.src = urlObject_2;
            }
        }

        //3.  Time handle
        let timer_1 = document.getElementById("current-timer1");
        let timer_2 = document.getElementById("current-timer2");
        setInterval(() => {
            let d = new Date();
            timer_1.innerHTML = d.toLocaleTimeString('en-US', {hour12: false});
            timer_2.innerHTML = d.toLocaleTimeString('en-US', {hour12: false});
        }, 1000);

        
        //4. Handler mode button để chọn mode Review  
        function handler_camera_1() {
            window.location.href = "/views/firstcamera.html"
        }
        function handler_camera_2() {
            window.location.href = "/views/secondcamera.html"
        }

        //5. Handler navigate page
        function handler_logout()
        {
            window.location.href = "/views/login.html"
        }
        function handler_specific_camera1() {
            window.location.href = "/views/firstcamera.html"
        }
        function handler_specific_camera2() {
            window.location.href = "/views/secondcamera.html"
        }

        //6. Handle action của button Pause and Play (Khởi tạo ban đầu cam đang hidden và khi play-> visible ngược lại pause->hidden)
        function handler_play_button1(){
            var enable = document.getElementById("cam_1_enabler");
            
            if(enable.innerHTML == "Pause")
            {
                enable.innerHTML = "Play";
                window["cam_1_enabler"] = false;
                document.getElementById("current-timer1").style.visibility = "hidden"
                img_1.style.visibility = "hidden"
            }
            else 
            {
                enable.innerHTML = "Pause";
                window["cam_1_enabler"] = true;
                document.getElementById("current-timer1").style.visibility = "visible"
                img_1.style.visibility = "visible"
            }
        }
        function handler_play_button2(){
            var enable = document.getElementById("cam_2_enabler");
            
            if(enable.innerHTML == "Pause")
            {
                enable.innerHTML = "Play";
                window["cam_2_enabler"] = false;
                document.getElementById("current-timer2").style.visibility = "hidden"
                img_2.style.visibility = "hidden"
            }
            else 
            {
                enable.innerHTML = "Pause";
                window["cam_2_enabler"] = true;
                document.getElementById("current-timer2").style.visibility = "visible"
                img_2.style.visibility = "visible"
            }
        }
        
        //7. Handle dot => có dòng stream khi đó dot được set visible và cứ 1s tạo hiệu ứng hidden. Còn nếu không thì hidden thôi
        function hideRedDot(){
            document.getElementById("cam_1_red_dot").style.visibility = "hidden";
            document.getElementById("cam_2_red_dot").style.visibility = "hidden";
        }

        setInterval(hideRedDot, 1000);

        //8. Save image
        function getFomattedTime(camInfo){
            var today = new Date();
            var y = today.getFullYear();
            var m = today.getMonth() + 1;
            var d = today.getDate();
            var h = today.getHours();
            var mi = today.getMinutes();
            var s = today.getSeconds();
            return camInfo + "-" + y + "-" + m + "-" + d + "-" + h + "-" + mi + "-" + s;
        }

        function forceDownload(url, fileName){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "blob";
            xhr.onload = function (){
                var urlCreator = window.URL || window.webkitURL;
                var imageUrl = urlCreator.createObjectURL(this.response);
                var tag = document.createElement("a");
                tag.href = imageUrl;
                tag.download = fileName;
                document.body.appendChild(tag);
                tag.click();
                document.body.removeChild(tag);
            };
            xhr.send();
        }


        function handler_save_image(source){
            var blobUrl = source === "cam_1_enabler" ? img_1.src : img_2.src;
            if(blobUrl.indexOf("blob") == -1){
                return;
            }
            var fileName = getFomattedTime(source === "cam_1_enabler" ? "ESP32CAM1" : "ESP32CAM2") + ".jpeg";
            forceDownload(blobUrl, fileName);
        }



    </script>
</body>

</html>
